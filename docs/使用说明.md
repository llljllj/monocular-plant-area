# 植物叶片面积还原算法 - 使用说明

## 📋 项目简介

本项目实现了基于图像的植物叶片真实面积测量系统，通过以下技术实现精确测量：
- **ArUco 标记检测**：用于相机位姿估计和像素-物理坐标转换
- **DeeplabV3 语义分割**：精确提取植物叶片区域
- **PnP 算法**：计算相机外参，实现透视校正
- **深度估计**：结合 YOLO 检测框，估算物体到相机的距离

---

## 🔧 环境配置

### 1. 系统要求
- Python 3.7 或更高版本
- Windows / Linux / macOS
- (可选) NVIDIA GPU + CUDA 用于加速推理

### 2. 依赖安装

```powershell
# 创建虚拟环境 (推荐)
python -m venv leonenv
.\leonenv\Scripts\Activate.ps1

# 安装依赖库
pip install torch torchvision  # PyTorch (根据 CUDA 版本选择)
pip install opencv-python opencv-contrib-python
pip install numpy pillow matplotlib
pip install pyyaml
pip install ultralytics  # YOLO (如需使用目标检测)
```

**注意**：如果使用 GPU，请根据 [PyTorch 官网](https://pytorch.org/) 安装对应 CUDA 版本的 torch。

---

## 📁 文件结构

```
植物面积还原算法/
├── pnp.py                                    # 主程序文件
├── Image_segmentation_prediction.py          # DeeplabV3 分割模型
├── models/
│   ├── plant_image_recognition20250821.pth  # 语义分割模型权重
│   └── plant.pt                             # YOLO 检测模型 (可选)
├── src/
│   └── 1/                                   # 待处理图像文件夹
│       ├── 1.jpg
│       ├── 2.jpg
│       └── ...
└── 使用说明.md                               # 本文档
```

---

## 🚀 使用方法

### 基本命令格式

```powershell
python pnp.py --folder <图像文件夹路径> --mode <处理模式>
```

### 参数说明

| 参数       | 说明                                   | 可选值             | 默认值                      |
|----------|--------------------------------------|-----------------|-----------------------------|
| `--folder` | 包含待处理图像的文件夹路径                 | 任意有效路径        | `src/1`                    |
| `--mode`   | 处理模式                              | `s` / `d` / `sd` | `s` (单独运行语义分割)         |

#### 模式详解

- **`s` (Segmentation Only)**: 仅运行语义分割
  - 使用 DeeplabV3 提取叶片区域
  - 计算像素面积
  - **不进行面积还原**（无需 ArUco 标记）
  
- **`d` (Detection + Area Restoration)**: 目标检测 + 面积还原
  - 使用 YOLO 检测植物目标
  - 通过 ArUco 标记进行透视校正
  - 计算真实物理面积
  - **需要图像中包含 ArUco 标记**
  
- **`sd` (Segmentation + Detection + Area Restoration)**: 完整流程
  - 先用 YOLO 定位植物
  - 再用 DeeplabV3 精确分割叶片
  - 结合 ArUco 标记还原真实面积
  - **推荐用于最高精度测量**

---

## 💡 使用示例

### 示例 1：仅进行叶片分割（无 ArUco 标记）

```powershell
python pnp.py --folder "D:\植物面积还原算法\src\1" --mode s
```

**输出**：
- 每张图像的叶片像素面积
- 保存分割掩码图像（可选）

---

### 示例 2：使用 YOLO + 面积还原（需要 ArUco 标记）

```powershell
python pnp.py --folder "D:\植物面积还原算法\src\1" --mode d
```

**输出**：
- ArUco 标记检测结果
- 相机内参矩阵
- 像素到厘米的转换比例
- 植物真实面积（平方厘米）

---

### 示例 3：完整流程（语义分割 + YOLO + 面积还原）

```powershell
python pnp.py --folder "D:\植物面积还原算法\src\1" --mode sd
```

**输出**：
- YOLO 检测框
- DeeplabV3 分割掩码
- 透视校正后的真实面积
- 可视化结果图

---

## 📷 图像要求

### 1. ArUco 标记要求（mode = `d` 或 `sd`）

**标记规格**：
- 字典类型：`DICT_6X6_250`
- 标记 ID：0, 1, 2, 3（四个角点）
- 物理尺寸：5 cm × 5 cm（正方形）

**摆放位置**：
- 四个标记构成矩形，**围绕植物放置**
- 矩形对角线长度：`marker_distance_cm = 30.0` cm（代码可配置）
- 确保标记完全可见，无遮挡

**示例布局**：
```
ID=0 ---- 30cm ---- ID=1
 |                    |
 |     (植物)         |
 |                    |
ID=3 ---- 30cm ---- ID=2
```

### 2. 图像质量要求
- **分辨率**：建议 ≥ 1920×1080
- **格式**：JPEG, PNG, BMP 等常见格式
- **光照**：均匀自然光，避免强烈阴影
- **对焦**：清晰无模糊
- **角度**：正面拍摄（避免过大倾斜角）

---

## ⚙️ 高级配置

### 修改 ArUco 标记参数

打开 `pnp.py`，找到以下代码段进行修改：

```python
# ArUco 字典类型
aruco_dict = cv2.aruco.getPredefinedDictionary(cv2.aruco.DICT_6X6_250)

# 标记物理尺寸 (厘米)
marker_size_cm = 5.0

# 标记矩形对角线长度 (厘米)
marker_distance_cm = 30.0
```

### 修改相机内参（可选）

如果您已知相机内参，可在代码中手动设置：

```python
# 示例：iPhone 12 Pro 相机内参
camera_matrix = np.array([
    [2500, 0, 1920],
    [0, 2500, 1440],
    [0, 0, 1]
], dtype=float)

dist_coeffs = np.array([0.1, -0.05, 0, 0, 0], dtype=float)
```

---

## 📊 输出结果说明

### 1. 像素面积（mode = `s`）
- 单位：像素（px²）
- 意义：图像平面上的叶片占用像素数
- 局限：无法表示真实物理尺寸

### 2. 真实面积（mode = `d` 或 `sd`）
- 单位：平方厘米（cm²）
- 计算公式：
  ```
  真实面积 = 像素面积 × (像素到厘米转换比例)²
  转换比例 = marker_distance_cm / 像素距离
  ```

### 3. 误差来源
- **语义分割误差**：模型精度、光照、遮挡
- **深度估计误差**：单目相机固有限制
- **透视失真**：拍摄角度偏离垂直方向
- **标记检测误差**：标记模糊或部分遮挡

**建议**：多次测量取平均值，减少随机误差。

---

## 🐛 常见问题

### 1. 中文路径问题

**问题**：OpenCV 在 Windows 下可能无法正确读取/写入中文路径的图像。

**解决方案**：
- ✅ **已修复**：项目中所有代码已更新为支持中文路径
- 使用方法：
  ```python
  # 读取图像（支持中文路径）
  img_data = np.fromfile(img_path, dtype=np.uint8)
  img = cv2.imdecode(img_data, cv2.IMREAD_COLOR)
  
  # 保存图像（支持中文路径）
  is_success, buffer = cv2.imencode('.jpg', img)
  buffer.tofile(output_path)
  ```
- 📝 可运行 `python test_chinese_path.py` 测试中文路径兼容性

---

### 2. `ModuleNotFoundError: No module named 'Image_segmentation_prediction'`

**原因**：缺少语义分割模块。

**解决方案**：确保 `Image_segmentation_prediction.py` 文件在同一目录下。

---

### 3. `RuntimeError: CUDA out of memory`

**原因**：GPU 显存不足。

**解决方案**：
- 在 `Image_segmentation_prediction.py` 中启用图像缩放：
  ```python
  max_size = 512  # 降低到 512 或 256
  ```
- 或强制使用 CPU：
  ```python
  self.device = torch.device('cpu')
  ```

---

### 4. 相机标定：`无法检测到棋盘格角点`

**原因**：
- 棋盘格规格设置错误
- 图像模糊或光照不足
- 棋盘格变形或有遮挡

**解决方案**：
1. **确认棋盘格规格**：
   - 内角点数 = 格子数 - 1
   - 例如：10×7 格子 → 9×6 内角点
   - 修改 `camera_calibration.py` 中的 `CHESSBOARD_SIZE`
2. **改善图像质量**：
   - 使用更高分辨率相机
   - 确保充足均匀光照
   - 避免图像模糊（使用三脚架）
3. **正确拍摄**：
   - 从多个角度（正面、左右、上下）
   - 棋盘格占据画面 50-80%
   - 拍摄 15-30 张不同角度的照片

---

### 5. `无法检测到 ArUco 标记`

**原因**：标记模糊、遮挡或光照不足。

**排查步骤**：
1. 检查标记是否完整可见
2. 确认标记 ID 为 0, 1, 2, 3
3. 提高图像亮度/对比度
4. 使用更高分辨率相机

---

### 6. `计算的面积明显偏大或偏小`

**原因**：
- 标记物理尺寸设置错误
- 相机内参不准确
- 拍摄角度过度倾斜

**解决方案**：
1. 使用卷尺验证标记实际尺寸，更新 `marker_size_cm`
2. 进行相机标定，获取准确内参
3. 保持相机与标记平面垂直

---

## 📧 技术支持

如遇到问题，请检查以下信息：
1. Python 版本：`python --version`
2. PyTorch 版本：`python -c "import torch; print(torch.__version__)"`
3. CUDA 是否可用：`python -c "import torch; print(torch.cuda.is_available())"`
4. 图像路径是否正确（使用绝对路径）

---

## 📝 更新日志

**v1.0 (2025-01-10)**
- 初始版本发布
- 支持 DeeplabV3 语义分割
- 支持 ArUco 标记 + PnP 算法的面积还原
- 支持三种处理模式（s / d / sd）

---

## 📄 许可证

本项目仅供研究和学习使用。

---

**祝您使用愉快！** 🌱
