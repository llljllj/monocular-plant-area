# 植物叶面积透视补偿算法

## 项目背景

在智能温室或植物生长监测场景中，使用普通单目摄像头进行叶面积估算时，相机姿态（高度、角度）的微小变化会导致显著的透视失真，从而使像素面积与实际物理面积之间产生较大偏差。

本项目旨在探索一种低成本方案：利用打印的棋盘格标定板和单目相机，通过姿态估计和尺度补偿，尝试缓解透视失真对叶面积测量的影响，实现像素面积向参考姿态下等效面积的粗略还原。

该方法不依赖深度传感器，仅使用普通USB摄像头和9×6棋盘格，适用于姿态变化相对可控的场景。

本方法适用于

## 方法概述

算法流程如下：

1. **植物区域检测与分割**  
   - 使用YOLOv8检测植物边界框  
   - 在边界框内应用DeeplabV3+进行语义分割，提取叶片像素区域并计算像素面积

2. **相机姿态估计**  
   - 检测棋盘格角点（cv2.findChessboardCorners + cornerSubPix）  
   - 通过solvePnP算法计算相机外参（旋转向量rvec、平移向量tvec）  
   - 以名为“1”的图像作为参考姿态，计算当前图像相对于参考的姿态变化（高度差、水平距离差、俯仰角差）

3. **尺度补偿与面积还原**  
   - 计算三种补偿因子：  
     - 基于棋盘格投影像素间距的尺度因子  
     - 基于PnP姿态估计的尺度因子  
     - PnP尺度因子结合俯仰角cos补偿（cos(θ_ref) / cos(θ_current)）  
   - 还原面积 = 当前像素面积 × (补偿因子)²  
   - 输出误差对比表（相对于参考图像的最大叶面积）

## 实验结果与误差分析

在实际大棚环境中采集的多组数据表明：

- 当相机姿态变化较小（高度变化≤15 cm，俯仰角变化≤5°）时：  
  - 未补偿误差约20–40%  
  - 采用PnP姿态补偿后，误差可降低至15–30%，适合用于生长趋势的相对监测

- 当姿态变化较大（高度变化≈45 cm，俯仰角变化≈11°）时：  
  - 未补偿误差可达130%以上  
  - PnP姿态补偿后误差仍为80–100%，角度补偿项在大角度下反而加剧偏差

主要误差来源包括：

- 棋盘格在图像中占比过小导致角点检测精度下降，进而放大PnP估计噪声  
- 俯仰角补偿的cos项在大角度（>8–10°）时近似失效  
- 叶片非严格共面（翘起、重叠、高低差），单一尺度因子无法同时适用于所有区域  
- 分割模型边缘误差（约5–10%）  
- 镜头残余畸变及光照条件变化

## 运行说明

### 环境准备

推荐使用Anaconda创建独立环境：

```bash
conda create -n plant_measure python=3.8
conda activate plant_measure

pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
pip install ultralytics opencv-python opencv-contrib-python pandas matplotlib pillow